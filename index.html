<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AMS Order From</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest + iOS support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007aff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f7;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 1rem;
    }
    label {
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.3rem;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      padding: 0.4rem;
      text-align: left;
    }
    th {
      border-bottom: 1px solid #ddd;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    input[type="number"] {
      width: 60px;
      padding: 0.2rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.85rem;
    }
    input[type="number"]:disabled {
      background: #eee;
      color: #888;
    }
    .btn {
      width: 100%;
      padding: 0.8rem;
      border: none;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 0.5rem;
      cursor: pointer;
      background: #007aff;
      color: white;
    }
    .btn:active {
      opacity: 0.8;
    }
    .note {
      font-size: 0.8rem;
      color: #666;
    }
    .inline-checkbox {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.6rem;
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
    }
    .two-column {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }
    @media (min-width: 600px) {
      .two-column {
        grid-template-columns: 1fr 1fr;
      }
    }
    .subheading {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0.4rem 0 0.2rem 0;
    }
    .row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.5rem;
    }

    /* ðŸ”¥ Sticky header for the items card */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #ffffff;
      padding-bottom: 0.5rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>

  <h1>AMS Order From</h1>

  <div class="card">
    <label for="customerName">Customer Name</label>
    <input id="customerName" type="text" placeholder="e.g. ABC Trucking" />

    <label for="shipTo" style="margin-top:0.6rem;">Ship To / Notes (optional)</label>
    <textarea id="shipTo" placeholder="Address, special instructions, etc."></textarea>

    <!-- New customer checkbox -->
    <div class="inline-checkbox">
      <input type="checkbox" id="newCustomer" />
      <label for="newCustomer" style="margin:0;">New customer</label>
    </div>

    <!-- New customer details (hidden until checked) -->
    <div id="newCustomerDetails" style="display:none; margin-top:0.75rem;">
      <div class="two-column">
        <!-- Shipping Address -->
        <div>
          <div class="subheading">Shipping Address</div>
          <label for="shipAddr1">Address Line 1 *</label>
          <input type="text" id="shipAddr1" />
          <label for="shipAddr2">Address Line 2 (optional)</label>
          <input type="text" id="shipAddr2" />

          <label>City, State, Zip *</label>
          <div class="row-3">
            <input type="text" id="shipCity" placeholder="City" />
            <input type="text" id="shipState" placeholder="State" />
            <input type="text" id="shipZip" placeholder="Zip" />
          </div>

          <label>Contact info *</label>
          <input type="text" id="shipContactName" placeholder="Contact Name" />
          <input type="text" id="shipContactPhone" placeholder="Contact Phone Number" />
          <input type="text" id="shipContactEmail" placeholder="Contact Email" />
        </div>

        <!-- Billing Address -->
        <div>
          <div class="subheading">Billing Address</div>

          <div class="inline-checkbox" style="margin-top:0;">
            <input type="checkbox" id="billingSameAsShipping" />
            <label for="billingSameAsShipping" style="margin:0;">Billing same as shipping</label>
          </div>

          <label for="billAddr1">Address Line 1 *</label>
          <input type="text" id="billAddr1" />
          <label for="billAddr2">Address Line 2 (optional)</label>
          <input type="text" id="billAddr2" />

          <label>City, State, Zip *</label>
          <div class="row-3">
            <input type="text" id="billCity" placeholder="City" />
            <input type="text" id="billState" placeholder="State" />
            <input type="text" id="billZip" placeholder="Zip" />
          </div>

          <label>Contact Info (for AP) *</label>
          <input type="text" id="billContactName" placeholder="Contact Name" />
          <input type="text" id="billContactPhone" placeholder="Contact Phone Number" />
          <input type="text" id="billContactEmail" placeholder="Contact Email" />
        </div>
      </div>

      <!-- Tax / County -->
      <div style="margin-top:0.75rem;">
        <div class="inline-checkbox">
          <input type="checkbox" id="taxExempt" />
          <label for="taxExempt" style="margin:0;">Customer is tax exempt</label>
        </div>

        <div id="countyRow" style="margin-top:0.4rem;">
          <label for="county">County (only if not tax exempt) *</label>
          <input type="text" id="county" />
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">Items</h2>
    <p class="note">Check the items being ordered and enter quantities.</p>

    <!-- ðŸŒŸ Sticky header area -->
    <div class="sticky-header">
      <button class="btn" style="margin-top:0;" onclick="generateEmail()">
        Generate Email
      </button>

      <!-- Search bar -->
      <label for="itemSearch" style="margin-top:0.6rem;">Search items</label>
      <input
        id="itemSearch"
        type="text"
        placeholder="Type to filter by name or UOM"
        style="margin-bottom:0.3rem;"
      />
    </div>

    <table>
      <thead>
        <tr>
          <th>âœ”</th>
          <th>Item</th>
          <th>UOM</th>
          <th>Qty</th>
        </tr>
      </thead>
      <tbody id="itemsTableBody">
        <tr><td colspan="4">If you can see this, JavaScript did not run.</td></tr>
      </tbody>
    </table>
  </div>

  <!-- The old bottom card with button is removed -->

  <script>
    // === CONFIGURE THESE ===
    var WAREHOUSE_EMAIL = "amssupply@outlook.com";
    var COMPANY_NAME = "AMS Supply";
    // =======================

    // Items will be loaded from items.json
    // Each item can be: { "name": "...", "uom": "...", "code": "..." }
    var ITEMS = [];

    function trimString(str) {
      return str.replace(/^\s+|\s+$/g, "");
    }

    function cleanName(rawName, uom) {
      if (!rawName || !uom) return rawName || "";
      var name = rawName;
      var u = trimString(uom);
      var suffix = " (" + u + ")";
      if (name.length >= suffix.length &&
          name.lastIndexOf(suffix) === name.length - suffix.length) {
        name = name.substring(0, name.length - suffix.length);
      }
      name = name.replace(/\s{2,}/g, " ");
      return trimString(name);
    }

    function buildItemsTable() {
      var tbody = document.getElementById("itemsTableBody");
      tbody.innerHTML = "";

      for (var i = 0; i < ITEMS.length; i++) {
        var item = ITEMS[i];

        var row = document.createElement("tr");

        // Checkbox
        var checkCell = document.createElement("td");
        var checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = "itemCheck_" + i;
        checkbox.setAttribute("data-qty-id", "itemQty_" + i);
        checkCell.appendChild(checkbox);

        // Name
        var nameCell = document.createElement("td");
        nameCell.textContent = cleanName(item.name, item.uom);

        // UOM
        var uomCell = document.createElement("td");
        uomCell.textContent = item.uom || "";

        // Qty input
        var qtyCell = document.createElement("td");
        var qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "1";
        qtyInput.step = "1";
        qtyInput.disabled = true;
        qtyInput.id = "itemQty_" + i;
        qtyCell.appendChild(qtyInput);

        row.appendChild(checkCell);
        row.appendChild(nameCell);
        row.appendChild(uomCell);
        row.appendChild(qtyCell);

        tbody.appendChild(row);
      }

      // Set up checkbox â†’ qty enable/disable
      var allCheckboxes = tbody.querySelectorAll("input[type=checkbox]");
      for (var j = 0; j < allCheckboxes.length; j++) {
        allCheckboxes[j].onchange = function () {
          var qtyId = this.getAttribute("data-qty-id");
          var input = document.getElementById(qtyId);
          if (!input) return;
          if (this.checked) {
            input.disabled = false;
          } else {
            input.disabled = true;
            input.value = "";
          }
        };
      }
    }

    // Search: hides/shows rows without changing IDs / selections
    function setupItemSearch() {
      var searchInput = document.getElementById("itemSearch");
      if (!searchInput) return;

      searchInput.addEventListener("input", function () {
        var term = trimString(this.value).toLowerCase();
        var tbody = document.getElementById("itemsTableBody");
        if (!tbody) return;

        var rows = tbody.getElementsByTagName("tr");
        for (var i = 0; i < rows.length; i++) {
          var row = rows[i];
          // columns: 1 = name, 2 = UOM
          var nameCell = row.cells[1];
          var uomCell = row.cells[2];
          if (!nameCell || !uomCell) continue;

          var nameText = nameCell.textContent.toLowerCase();
          var uomText = (uomCell.textContent || "").toLowerCase();

          if (!term) {
            row.style.display = "";
          } else if (
            nameText.indexOf(term) !== -1 ||
            uomText.indexOf(term) !== -1
          ) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        }
      });
    }

    function setupNewCustomerSection() {
      var newCustomer = document.getElementById("newCustomer");
      var details = document.getElementById("newCustomerDetails");
      var billingSame = document.getElementById("billingSameAsShipping");
      var taxExempt = document.getElementById("taxExempt");
      var countyRow = document.getElementById("countyRow");

      function setDetailsVisibility() {
        if (newCustomer && newCustomer.checked) {
          details.style.display = "block";
        } else {
          details.style.display = "none";
        }
      }

      function setBillingSameState() {
        var shipAddr1 = document.getElementById("shipAddr1");
        var shipAddr2 = document.getElementById("shipAddr2");
        var shipCity = document.getElementById("shipCity");
        var shipState = document.getElementById("shipState");
        var shipZip = document.getElementById("shipZip");
        var shipContactName = document.getElementById("shipContactName");
        var shipContactPhone = document.getElementById("shipContactPhone");
        var shipContactEmail = document.getElementById("shipContactEmail");

        var billAddr1 = document.getElementById("billAddr1");
        var billAddr2 = document.getElementById("billAddr2");
        var billCity = document.getElementById("billCity");
        var billState = document.getElementById("billState");
        var billZip = document.getElementById("billZip");
        var billContactName = document.getElementById("billContactName");
        var billContactPhone = document.getElementById("billContactPhone");
        var billContactEmail = document.getElementById("billContactEmail");

        if (!billAddr1 || !billAddr2 || !billCity || !billState || !billZip ||
            !billContactName || !billContactPhone || !billContactEmail) return;

        if (billingSame && billingSame.checked) {
          billAddr1.value = shipAddr1 ? shipAddr1.value : "";
          billAddr2.value = shipAddr2 ? shipAddr2.value : "";
          billCity.value = shipCity ? shipCity.value : "";
          billState.value = shipState ? shipState.value : "";
          billZip.value = shipZip ? shipZip.value : "";
          billContactName.value = shipContactName ? shipContactName.value : "";
          billContactPhone.value = shipContactPhone ? shipContactPhone.value : "";
          billContactEmail.value = shipContactEmail ? shipContactEmail.value : "";

          billAddr1.disabled = true;
          billAddr2.disabled = true;
          billCity.disabled = true;
          billState.disabled = true;
          billZip.disabled = true;
          billContactName.disabled = true;
          billContactPhone.disabled = true;
          billContactEmail.disabled = true;
        } else {
          billAddr1.disabled = false;
          billAddr2.disabled = false;
          billCity.disabled = false;
          billState.disabled = false;
          billZip.disabled = false;
          billContactName.disabled = false;
          billContactPhone.disabled = false;
          billContactEmail.disabled = false;
        }
      }

      function setCountyVisibility() {
        if (taxExempt && taxExempt.checked) {
          countyRow.style.display = "none";
          var countyInput = document.getElementById("county");
          if (countyInput) countyInput.value = "";
        } else {
          countyRow.style.display = "block";
        }
      }

      if (newCustomer) {
        newCustomer.onchange = setDetailsVisibility;
        setDetailsVisibility();
      }

      if (billingSame) {
        billingSame.onchange = setBillingSameState;
      }

      if (taxExempt) {
        taxExempt.onchange = setCountyVisibility;
        setCountyVisibility();
      }
    }

    function validateNewCustomerFields() {
      var newCustomer = document.getElementById("newCustomer");
      if (!(newCustomer && newCustomer.checked)) {
        return true; // no extra validation needed
      }

      function val(id) {
        var el = document.getElementById(id);
        return el ? trimString(el.value || "") : "";
      }

      // Shipping required (except shipAddr2)
      var shipAddr1 = val("shipAddr1");
      var shipCity = val("shipCity");
      var shipState = val("shipState");
      var shipZip = val("shipZip");
      var shipContactName = val("shipContactName");
      var shipContactPhone = val("shipContactPhone");
      var shipContactEmail = val("shipContactEmail");

      if (!shipAddr1 || !shipCity || !shipState || !shipZip ||
          !shipContactName || !shipContactPhone || !shipContactEmail) {
        alert("Please fill in all required Shipping fields for the new customer (everything with *).");
        return false;
      }

      var billingSame = document.getElementById("billingSameAsShipping");
      if (!billingSame || !billingSame.checked) {
        // Billing required (except billAddr2)
        var billAddr1 = val("billAddr1");
        var billCity = val("billCity");
        var billState = val("billState");
        var billZip = val("billZip");
        var billContactName = val("billContactName");
        var billContactPhone = val("billContactPhone");
        var billContactEmail = val("billContactEmail");

        if (!billAddr1 || !billCity || !billState || !billZip ||
            !billContactName || !billContactPhone || !billContactEmail) {
          alert("Please fill in all required Billing fields for the new customer (everything with *).");
          return false;
        }
      }

      var taxExempt = document.getElementById("taxExempt");
      var county = val("county");
      if (!(taxExempt && taxExempt.checked)) {
        // not tax exempt â†’ county required
        if (!county) {
          alert("Please enter County for the new customer (required if not tax exempt).");
          return false;
        }
      }

      return true;
    }

    function generateEmail() {
      var customerName = trimString(document.getElementById("customerName").value);
      var shipTo = trimString(document.getElementById("shipTo").value);
      var newCustomer = document.getElementById("newCustomer");

      if (!customerName) {
        alert("Please enter the customer name.");
        return;
      }

      // Validate new customer fields if needed
      if (!validateNewCustomerFields()) {
        return;
      }

      var lines = [];
      var invalid = false;

      // Build item lines
      for (var i = 0; i < ITEMS.length; i++) {
        var checkbox = document.getElementById("itemCheck_" + i);
        var qtyInput = document.getElementById("itemQty_" + i);
        if (checkbox && checkbox.checked) {
          var qty = trimString(qtyInput.value);
          var qtyNum = Number(qty);
          if (!qty || isNaN(qtyNum) || qtyNum <= 0) {
            invalid = true;
          } else {
            var displayName = cleanName(ITEMS[i].name, ITEMS[i].uom);
            var uomText = ITEMS[i].uom || "";
            var codeText = ITEMS[i].code || "";
            var line = "- " + qty + " x " + displayName + " (" + uomText + ")";
            if (codeText) {
              line += " / " + codeText;
            }
            lines.push(line);
          }
        }
      }

      if (invalid) {
        alert("For each checked item, enter a quantity of at least 1.");
        return;
      }

      if (lines.length === 0) {
        alert("Please select at least one item and enter quantities.");
        return;
      }

      var subject = "Order for " + customerName;

      var body = "New order for customer: " + customerName + "\n\n";
      body += "Please pick and pack the following:\n\n";
      body += lines.join("\n") + "\n\n";

      if (shipTo) {
        body += "Ship To / Notes:\n" + shipTo + "\n\n";
      }

      // New customer info
      if (newCustomer && newCustomer.checked) {
        function val(id) {
          var el = document.getElementById(id);
          return el ? trimString(el.value || "") : "";
        }

        var billingSame = document.getElementById("billingSameAsShipping");

        // Shipping
        var shipAddr1 = val("shipAddr1");
        var shipAddr2 = val("shipAddr2");
        var shipCity = val("shipCity");
        var shipState = val("shipState");
        var shipZip = val("shipZip");
        var shipContactName = val("shipContactName");
        var shipContactPhone = val("shipContactPhone");
        var shipContactEmail = val("shipContactEmail");

        // Billing (if same as shipping, display same details)
        var billAddr1, billAddr2, billCity, billState, billZip;
        var billContactName, billContactPhone, billContactEmail;

        if (billingSame && billingSame.checked) {
          billAddr1 = shipAddr1;
          billAddr2 = shipAddr2;
          billCity = shipCity;
          billState = shipState;
          billZip = shipZip;
          billContactName = shipContactName;
          billContactPhone = shipContactPhone;
          billContactEmail = shipContactEmail;
        } else {
          billAddr1 = val("billAddr1");
          billAddr2 = val("billAddr2");
          billCity = val("billCity");
          billState = val("billState");
          billZip = val("billZip");
          billContactName = val("billContactName");
          billContactPhone = val("billContactPhone");
          billContactEmail = val("billContactEmail");
        }

        var taxExempt = document.getElementById("taxExempt");
        var county = val("county");

        body += "New customer information:\n\n";

        body += "Shipping Address:\n";
        if (shipAddr1) body += shipAddr1 + "\n";
        if (shipAddr2) body += shipAddr2 + "\n";
        if (shipCity || shipState || shipZip) {
          body += [shipCity, shipState, shipZip].filter(function (p) { return p; }).join(", ") + "\n";
        }
        if (shipContactName) body += "Contact Name: " + shipContactName + "\n";
        if (shipContactPhone) body += "Contact Phone: " + shipContactPhone + "\n";
        if (shipContactEmail) body += "Contact Email: " + shipContactEmail + "\n";
        body += "\n";

        body += "Billing Address:\n";
        if (billAddr1) body += billAddr1 + "\n";
        if (billAddr2) body += billAddr2 + "\n";
        if (billCity || billState || billZip) {
          body += [billCity, billState, billZip].filter(function (p) { return p; }).join(", ") + "\n";
        }
        if (billContactName) body += "Contact Name (AP): " + billContactName + "\n";
        if (billContactPhone) body += "Contact Phone (AP): " + billContactPhone + "\n";
        if (billContactEmail) body += "Contact Email (AP): " + billContactEmail + "\n";
        body += "\n";

        body += "Tax Exempt Status: " + (taxExempt && taxExempt.checked ? "Tax Exempt" : "Taxable") + "\n";
        if (!(taxExempt && taxExempt.checked) && county) {
          body += "County: " + county + "\n";
        }
        body += "\n";
      }

      body += "Thank you,\n";

      var mailto = "mailto:" + encodeURIComponent(WAREHOUSE_EMAIL)
        + "?subject=" + encodeURIComponent(subject)
        + "&body=" + encodeURIComponent(body);

      window.location.href = mailto;
    }

    function initPage() {
      buildItemsTable();
      setupItemSearch();
      setupNewCustomerSection();
    }

    // Load items from items.json, THEN init
    function loadItemsAndInit() {
      if (typeof fetch === "function") {
        fetch("items.json")
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (Object.prototype.toString.call(data) === "[object Array]") {
              ITEMS = data;
            } else {
              console.log("items.json did not contain an array; using empty list.");
              ITEMS = [];
            }
            initPage();
          })
          .catch(function (error) {
            console.log("Error loading items.json:", error);
            ITEMS = [];
            initPage();
          });
      } else {
        ITEMS = [];
        initPage();
      }
    }

    // Build UI when page loads
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", loadItemsAndInit);
    } else {
      loadItemsAndInit();
    }

    // Register service worker (for PWA)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .catch(function (err) {
          console.log("Service worker registration failed:", err);
        });
    }
  </script>

</body>
</html>
